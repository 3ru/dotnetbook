# Домены приложений

Самое время пришло поговорить про домены приложений (AppDomains). Причем если вы скажете, что эта тема достаточно элементарна и понятна чтобы позволить себе пропустить данную главу, то в её защиту скажу что тема эта кажется такой простой по одной причине: её зачем-то обходят стороной тогда как если вглядеться поглуже, выяснится что она очень интересна и многогранна.

Начнем мы наше изучение с несколько философского вопроса: зачем вообще вводили домены приложений? Для ответа на этот вопрос необходимо немного окунуться в историю: когда миром правил С++ и технология COM, мир только прощупывал почву чтобы изобрести что-то наподобие нашей любимой платформы. Работа приложений по большей части была построена следующим образом: если некоторое приложение позволяет расширять собственный функционал, то оно должно выставить некоторые стандартизированные методы наружу: это либо банальный экспорт методов либо экспорт объектно-ориентированного API через COM. Однако, поскольку мы в любом случае имеем дело с общей для обоих участников процесса памятью (память линейна для процесса, процессы изолированы друг от друга), то и программа и код, ее расширяющий имеют общий доступ к памяти друг друга. Между ними изоляции нет. А потому, правильным образом пошаманив с указателями можно легко и просто прочитать память хоста, находясь в плагине.

Это вызывает множество проблем с безопасностью: если само приложение можно сделать безопасным с точки зрения проникновения, то расширив его функционал сторонним кодом такая уверенность сходит на нет: вы более не можете надеяться что пользователь не сможет скачать со стороннего ресурса некий вылеченый от жадности плагин к вашему приложению чтобы запустить его. Конечно же, бесплатный сыр бывает только в мышеловке: установив плагин и запустив приложение вы ничего не заметите, но внедренный авторами сайта, с которого скачан плагин код начнет изучать ваш компьютер в поисках наживы. Или просто заснет до лучших времен, когда такая нажива на вашем компьютере появится.

Одним из решений подобной проблемы может стать запуск плагинов в отдельных процессах: это будет идеальной изоляцией памяти хоста от его расширений на уровне железа: процессы изолируются процессором. Однако, это накладывает определенные ограничения: скорость заметно снижается на всех этапах взаимодействия. Ведь при вызове методов API вы должны:

  - Сериализовать данные (параметры метода)
  - Осуществить передачу до получателя:
    - Например, через сокет
    - Или Shared Memory
  - На другом конце - десериализовать
  - Вызвать метод

Т.е. выполнить очень много действий. Однако плата хоть и велика, результат будет прекрасен: при вызове метода гарантируется полная изоляция между хостом и плагинами.

Теория звучит великолепно если бы не одно "но": необходимы дополнительные средства автоматизации кодогенерации библиотеки для клиента и хоста по некоторому файлу с описанием интерфейса API. Иначе велик риск человеческого фактора при ручной реализации такой обертки.

Однако, в данном разговоре не хватает понимания: что конкретно и от чего (а главное, почему?) мы защищаемся. Защитить мы пытаемся наши данные, которые могут содержать некие пароли, средства доступа к нашим финансам и личным фотоархивам. Скрывать всегда есть что, однако скрываем мы всегда данные. От чего мы их скрываем? От неких действий. Если нет действий, значит данные находятся в безопасности. Значит, если обзавестись средством контроля над тем, что делает наш плагин, значит мы получим средство обеспечения безопасности наших данных не прибегая к созданию сложной системы взаимодействия между процессами.

И механизм этот - домены приложений.